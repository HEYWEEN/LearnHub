<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>LearnHub 视频与文件测试页（含正确 HLS 流程）</title>
  <style>
    body { max-width: 820px; margin: 28px auto; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial; line-height: 1.45; }
    h2 { margin-top: 0; }
    label { display:block; margin-top:10px; font-weight:600; }
    input[type="text"], input[type="file"] { width:100%; padding:8px; margin-top:6px; box-sizing:border-box; }
    button { width:100%; padding:10px; margin:10px 0; background:#1366ff;color:#fff;border:none;border-radius:6px;cursor:pointer; font-size:15px; }
    button.secondary { background:#888; }
    video, img { margin-top: 12px; width:100%; background:#000; display:block; }
    pre { background:#f7f7f8; padding:10px; border-radius:6px; overflow:auto; max-height:220px; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .full { grid-column: 1 / -1; }
  </style>

  <!-- HLS.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body>
  <h2>LearnHub 测试页 — 播放 / HLS / 上传</h2>

  <label>后端地址（例如 http://localhost:3000）</label>
  <input id="base" type="text" value="http://localhost:3000" />

  <label>JWT Token（可选，填原始 token，不要带 Bearer）</label>
  <input id="token" type="text" placeholder="示例：eyJhbGciOiJI..." />

  <div class="row">
    <div>
      <label>课程 ID (courseId)</label>
      <input id="courseId" type="text" placeholder="例如 7b22db86-..." />
    </div>
    <div>
      <label>章节 ID (lessonId，播放预览留空)</label>
      <input id="lessonId" type="text" placeholder="例如 0885a349-..." />
    </div>
  </div>

  <button onclick="playMp4()">▶ 播放 MP4（stream / video-preview）</button>
  <button onclick="generateAndPlayHls()">▶ 生成并播放 HLS（POST /:lesson/hls → 播放返回的 m3u8）</button>

  <video id="player" controls></video>

  <hr />

  <div class="row">
    <div>
      <h3>上传课程封面</h3>
      <input id="coverFile" type="file" accept="image/*" />
      <button onclick="uploadCover()">上传封面 (POST /cover-img)</button>
      <img id="coverPreview" alt="封面预览" />
    </div>

    <div>
      <h3>上传课程预览视频</h3>
      <input id="videoFile" type="file" accept="video/*" />
      <button onclick="uploadPreview()">上传预览视频 (POST /video-preview)</button>
      <video id="videoPreview" controls></video>
    </div>
  </div>

  <hr />
  <h3>调试输出</h3>
  <pre id="log">控制台日志会显示在这里（点击按钮查看）。</pre>

<script>
/* ---------- 小工具 ---------- */

function log(...args) {
  const p = document.getElementById('log');
  const time = new Date().toLocaleTimeString();
  p.textContent = `${time}  ${args.map(a => typeof a === 'string' ? a : JSON.stringify(a,null,2)).join(' ')}\n` + p.textContent;
  console.log(...args);
}

function getBase() {
  return document.getElementById('base').value.trim().replace(/\/+$/,'');
}
function getTokenHeader() {
  const t = document.getElementById('token').value.trim();
  return t ? { 'Authorization': 'Bearer ' + t } : {};
}

/* ---------- 普通 mp4 播放 ---------- */

async function playMp4() {
  try {
    const base = getBase();
    const cid = document.getElementById('courseId').value.trim();
    const lid = document.getElementById('lessonId').value.trim();
    const token = document.getElementById('token').value.trim();

    if (!cid) return alert('请填写 courseId');

    let url;
    if (lid) {
      url = `${base}/api/courses/${cid}/lesson/${lid}/stream`;
    } else {
      url = `${base}/api/courses/${cid}/video-preview`;
    }

    // 若需要 token，我们采用 query token 方式以保持 Range 与浏览器原生支持
    if (token) {
      url += (url.includes('?') ? '&' : '?') + 'token=' + encodeURIComponent(token);
    }

    log('播放 MP4 地址 ->', url);
    const player = document.getElementById('player');
    // 直接给 video src，保持 Range 原生支持
    player.src = url;
    try { await player.play(); log('视频播放已开始'); } catch(e) { log('自动播放被阻止或需手动播放', e); }
  } catch (err) {
    log('playMp4 错误', err);
    alert('播放失败，查看控制台日志');
  }
}

/* ---------- 生成并播放 HLS（正确流程） ---------- */

async function generateAndPlayHls() {
  try {
    const base = getBase();
    const cid = document.getElementById('courseId').value.trim();
    const lid = document.getElementById('lessonId').value.trim();
    const token = document.getElementById('token').value.trim();

    if (!cid || !lid) return alert('生成 HLS 需要 courseId 与 lessonId 都填写');

    const url = `${base}/api/courses/${cid}/lesson/${lid}/hls`;
    log('请求生成 HLS ->', url);

    const headers = Object.assign({}, getTokenHeader(), { 'Accept': 'application/json' });

    const res = await fetch(url, {
      method: 'POST',
      headers,
    });

    if (!res.ok) {
      const txt = await res.text().catch(()=>null);
      log('生成 HLS 返回非 2xx', res.status, txt);
      return alert('生成 HLS 失败: ' + res.status + '，详见 console');
    }

    const json = await res.json();
    log('生成 HLS 返回数据', json);

    // videoController 返回的字段名在你代码里是 playlistUrl
    const playlistUrl = json?.data?.playlistUrl || json?.data?.playlist || json?.data?.playlistUrl; 
    if (!playlistUrl) {
      log('响应中未找到 playlistUrl 字段', json);
      return alert('服务器未返回 m3u8 地址，请查看后端日志或控制台');
    }

    // playlistUrl 可能是以 '/uploads/...' 开头，也可能是绝对 URL
    const finalUrl = playlistUrl.startsWith('http') ? playlistUrl : base + (playlistUrl.startsWith('/') ? playlistUrl : '/' + playlistUrl);
    log('播放 m3u8 ->', finalUrl);

    playHlsWithUrl(finalUrl);
  } catch (err) {
    log('generateAndPlayHls 错误', err);
    alert('生成或播放 HLS 失败，查看控制台');
  }
}

/* HLS 播放器（hls.js + 原生兼容） */
function playHlsWithUrl(m3u8Url) {
  const video = document.getElementById('player');
  // 先停止并清空原先 src
  video.pause();
  try { if (video.src) { URL.revokeObjectURL(video.src); } } catch(e){}

  if (video.canPlayType('application/vnd.apple.mpegurl')) {
    log('浏览器原生支持 HLS（Safari）');
    video.src = m3u8Url;
    video.play().catch(e => log('auto play blocked', e));
    return;
  }

  if (Hls.isSupported()) {
    // 解除已有 hls 实例（如果有）
    if (window._currentHls) {
      try { window._currentHls.destroy(); } catch(e){ log('destroy hls err', e); }
      window._currentHls = null;
    }
    const hls = new Hls();
    window._currentHls = hls;
    hls.on(Hls.Events.ERROR, (event, data) => {
      log('hls error', event, data);
    });
    hls.loadSource(m3u8Url);
    hls.attachMedia(video);
    hls.on(Hls.Events.MANIFEST_PARSED, () => {
      log('HLS manifest parsed, 尝试播放');
      video.play().catch(e=>log('hls autoplay blocked', e));
    });
    return;
  }

  alert('当前浏览器不支持 HLS（建议使用 Chrome + hls.js 或 Safari）');
}

/* ---------- 上传 （封面 / 预览视频） ---------- */

async function uploadCover() {
  try {
    const base = getBase();
    const cid = document.getElementById('courseId').value.trim();
    const fi = document.getElementById('coverFile');

    if (!cid) return alert('请填写 courseId');
    if (!fi.files.length) return alert('请选择图片文件');

    const form = new FormData();
    form.append('image', fi.files[0]);

    const url = `${base}/api/courses/${cid}/cover-img`;
    log('上传封面 ->', url);

    const res = await fetch(url, {
      method: 'POST',
      headers: getTokenHeader(), // 不设置 Content-Type，浏览器会自动设置 multipart boundary
      body: form
    });

    if (!res.ok) {
      const txt = await res.text().catch(()=>null);
      log('上传封面失败', res.status, txt);
      return alert('上传失败：' + res.status);
    }

    const json = await res.json();
    log('上传封面返回', json);
    alert('上传封面返回：' + JSON.stringify(json, null, 2));

    if (json?.success && json?.data?.course?.cover_image) {
      const preview = document.getElementById('coverPreview');
      preview.src = (json.data.course.cover_image.startsWith('http') ? json.data.course.cover_image : base + json.data.course.cover_image);
    }
  } catch (err) {
    log('uploadCover err', err);
    alert('上传封面失败，查看 console');
  }
}

async function uploadPreview() {
  try {
    const base = getBase();
    const cid = document.getElementById('courseId').value.trim();
    const fi = document.getElementById('videoFile');

    if (!cid) return alert('请填写 courseId');
    if (!fi.files.length) return alert('请选择视频文件');

    const form = new FormData();
    form.append('video', fi.files[0]);

    const url = `${base}/api/courses/${cid}/video-preview`;
    log('上传课程预览视频 ->', url);

    const res = await fetch(url, {
      method: 'POST',
      headers: getTokenHeader(),
      body: form
    });

    if (!res.ok) {
      const txt = await res.text().catch(()=>null);
      log('上传视频返回非 2xx', res.status, txt);
      return alert('上传视频失败：' + res.status);
    }

    const json = await res.json();
    log('uploadPreview 返回', json);
    alert('上传预览返回：' + JSON.stringify(json, null, 2));

    if (json?.success && json?.data?.course?.video_preview) {
      const v = document.getElementById('videoPreview');
      v.src = (json.data.course.video_preview.startsWith('http') ? json.data.course.video_preview : base + json.data.course.video_preview);
    }
  } catch (err) {
    log('uploadPreview err', err);
    alert('上传预览视频失败，查看 console');
  }
}

/* ---------- 页面载入自检 ---------- */
(function init() {
  log('测试页准备就绪。提示：要播放 HLS，先点击 "生成并播放 HLS" 按钮（会 POST /hls），然后播放器会播放后端生成的 m3u8。');
})();
</script>
</body>
</html>
